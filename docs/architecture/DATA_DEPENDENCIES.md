# Data Dependencies - orbit-engine Integration

**ÁõÆÁöÑ**: ÊòéÁ¢∫ handover-rl Â∞ç orbit-engine Ëº∏Âá∫ÁöÑ‰æùË≥¥Èóú‰øÇ

---

## üéØ Critical Dependency: Starlink Satellite Pool (Stage 4)

### What We Need
**101 Starlink satellites from Stage 4 optimization**:
- ‚úÖ **101 Starlink** (550km LEO) - **Used in this project**
- ‚ùå **24 OneWeb** (1200km LEO) - **Not used** (cross-constellation handover unrealistic)

**Project Scope**: Starlink-only constellation

**Rationale**:
- Ê†πÊìö 2023-2025 ÊñáÁçªË™øÁ†îÔºå**ÊâÄÊúâ LEO satellite handover Ë´ñÊñáÈÉΩ‰ΩøÁî®ÂñÆ‰∏ÄÊòüÂ∫ß**ÔºàStarlink OR OneWebÔºâÔºåÂæûÊú™ÊúâË∑®ÊòüÂ∫ßÊèõÊâãÁöÑÁ†îÁ©∂
- Ë∑®ÊòüÂ∫ßÊèõÊâãÂú®ÂïÜÊ•≠‰∏ä‰∏çÁèæÂØ¶Ôºàlike AT&T vs Verizon - ‰∏çÂêåÁöÑÈÅãÁáüÂïÜ„ÄÅÂú∞Èù¢Á´ô„ÄÅÁî®Êà∂ÁµÇÁ´ØÔºâ
- Starlink Êèê‰æõÊõ¥Â§öË®ìÁ∑¥Êï∏ÊìöÔºö101 satellites vs 24 satellites (4.2ÂÄçÂÑ™Âã¢)

Ë©≥Ë¶ã [CONSTELLATION_CHOICE.md](CONSTELLATION_CHOICE.md) ÂÆåÊï¥Ë™™Êòé

### Where to Get It

**File Path**:
```
/home/sat/satellite/orbit-engine/data/outputs/stage4/link_feasibility_output_YYYYMMDD_HHMMSS.json
```

**JSON Structure**:
```json
{
  "pool_optimization": {
    "optimized_pools": {
      "starlink": [
        {
          "satellite_id": "45540",  // ‚Üê Use this as satellite_id
          "name": "45540",
          "constellation": "starlink",
          "time_series": [...],
          "service_window": {...}
        },
        // ... 101 satellites total
      ],
      "oneweb": [
        {
          "satellite_id": "48058",  // ‚Üê Use this as satellite_id
          "name": "48058",
          "constellation": "oneweb",
          "time_series": [...],
          "service_window": {...}
        },
        // ... 24 satellites total
      ]
    }
  }
}
```

### How to Extract (Correct Implementation)

```python
import json
from pathlib import Path

def load_stage4_starlink_satellites() -> list[str]:
    """
    Load 101 Starlink satellites from orbit-engine Stage 4 output

    **Project Scope**: Starlink-only (cross-constellation handover unrealistic)

    Returns:
        List of 101 Starlink satellite IDs (NORAD catalog numbers as strings)

    SOURCE: orbit-engine Stage 4 Pool Optimization
    NO HARDCODING: Reads from actual six-stage processing output
    """
    # Find latest Stage 4 output
    stage4_dir = Path("/home/sat/satellite/orbit-engine/data/outputs/stage4")
    stage4_files = sorted(stage4_dir.glob("link_feasibility_output_*.json"))

    if not stage4_files:
        raise FileNotFoundError(
            f"No Stage 4 output found in {stage4_dir}. "
            "Run orbit-engine stages 1-4 first."
        )

    latest_file = stage4_files[-1]

    with open(latest_file) as f:
        data = json.load(f)

    pools = data['pool_optimization']['optimized_pools']

    # Extract Starlink satellite IDs only
    starlink_pool = pools.get('starlink', [])
    satellite_ids = [sat['satellite_id'] for sat in starlink_pool]

    # Validation
    assert len(satellite_ids) == 101, \
        f"Expected 101 Starlink satellites, got {len(satellite_ids)}"

    return satellite_ids
```

---

## ‚ùå WRONG APPROACHES (DO NOT USE)

### ‚ùå Wrong 1: Extract from TLE Files Directly
```python
# ‚ùå WRONG: Bypasses six-stage optimization
satellite_ids = extract_satellites_from_tle(tle_file, max_satellites=125)
```

**Why Wrong**:
- TLE has 8000+ satellites, but only 125 passed Stage 1-4 optimization
- Skips visibility analysis, service window calculation, pool optimization
- Violates academic requirement: use processed data, not raw data

### ‚ùå Wrong 2: Extract from TLE by Prefix Only
```python
# ‚ùå WRONG: Bypasses Stage 4 optimization
satellite_ids = extract_satellites_from_tle(tle_file, prefix="STARLINK", max_satellites=101)
```

**Why Wrong**:
- Bypasses Stage 4 optimization (visibility analysis, service windows)
- Not all Starlink satellites are suitable for handover scenarios
- Should use Stage 4 scientifically-selected pool, not arbitrary TLE selection

### ‚ùå Wrong 3: Use "Dynamic Pool Selection" Calculations
```python
# ‚ùå WRONG: Reimplements what Stage 4 already did
pool_size = calculate_from_orbital_mechanics(...)
satellite_ids = extract_satellites_from_tle(tle_file, max_satellites=pool_size)
```

**Why Wrong**:
- Duplicates orbit-engine Stage 4 Pool Optimization logic
- Ignores actual visibility analysis and service windows
- Results won't match Stage 4 scientific selection criteria

---

## ‚úÖ Verification Steps

### Before Running handover-rl Training

```bash
# 1. Check Stage 4 output exists
ls -lh /home/sat/satellite/orbit-engine/data/outputs/stage4/link_feasibility_output_*.json

# 2. Verify Starlink satellite count
python3 -c "
import json
from pathlib import Path

stage4_dir = Path('/home/sat/satellite/orbit-engine/data/outputs/stage4')
latest = sorted(stage4_dir.glob('link_feasibility_output_*.json'))[-1]

with open(latest) as f:
    data = json.load(f)

pools = data['pool_optimization']['optimized_pools']
print(f'Starlink: {len(pools[\"starlink\"])} satellites')
print(f'OneWeb: {len(pools[\"oneweb\"])} satellites (not used in this project)')
print(f'Project uses: {len(pools[\"starlink\"])} Starlink satellites only')
"

# Expected output:
# Starlink: 101 satellites
# OneWeb: 24 satellites (not used in this project)
# Project uses: 101 Starlink satellites only
```

### After Loading Satellites in Training Script

```python
satellite_ids = load_stage4_starlink_satellites()

# Verify
print(f"‚úÖ Loaded {len(satellite_ids)} Starlink satellites")
print(f"   First 3: {satellite_ids[:3]}")  # Should be NORAD IDs like ['45540', '46701', ...]
print(f"   Last 3: {satellite_ids[-3:]}")   # Should be Starlink IDs

# Check for Starlink
assert len(satellite_ids) == 101, "Should have exactly 101 Starlink satellites"
assert '45540' in satellite_ids  # Starlink example
```

---

## üîÑ Relationship with Stage 5 & Stage 6

### Stage 5: Signal Quality Analysis

**What Stage 5 Provides**:
- Signal quality calculation **algorithms** (ITU-R P.676 + 3GPP TS 38.214/38.215)
- RSRP/RSRQ/SINR computation methods
- Pre-computed signal data for fixed time range (JSON output)

**How handover-rl Uses It**:
- ‚úÖ **Uses the algorithms** (ITU-R + 3GPP calculators via OrbitEngineAdapter)
- ‚ùå **Does NOT read Stage 5 JSON output**

**Why Not Read JSON**:
- Stage 5 JSON = Fixed time range (pre-computed)
- RL training = Arbitrary time points (random exploration)
- **Solution**: Real-time calculation using same algorithms

**Implementation**:
```python
# OrbitEngineAdapter uses Stage 5 algorithms
from orbit_engine.stages.stage5_signal_analysis import GPPSignalCalculator

signal_quality = self.gpp_calc.calculate_complete_signal_quality(
    distance_km=...,
    elevation_deg=...,
    # ... other params
)
# Returns: rsrp_dbm, rsrq_db, rs_sinr_db
```

**Key Point**: Uses **algorithms** ‚â† Reads **output files**

---

### Stage 6: Research Optimization & 3GPP Events

**What Stage 6 Provides**:
- 3GPP NTN events (A3/A4/A5/D2) - Traditional rule-based handover
- Pool verification statistics
- ML training data generation (‚ö†Ô∏è **Not implemented** - marked as future work)

**How handover-rl Uses It**:
- ‚ö†Ô∏è **Optional**: 3GPP events for baseline comparison experiments
- ‚ùå **Not used**: ML training data (not implemented in orbit-engine)
- ‚úÖ **Indirectly**: Pool verification confirms 125-satellite quality

**When to Use Stage 6**:
- For baseline comparison: RL agent vs A3 event-based handover
- For performance evaluation: Compare RL learned policy vs traditional rules

**orbit-engine Documentation Quote**:
```
Stage 6 Ê†∏ÂøÉÂäüËÉΩ:
1. 3GPP ‰∫ã‰ª∂Ê™¢Ê∏¨ (A3/A4/A5/D2)
2. Pool Verification

Êú™‰æÜÊì¥Â±ï (ÂæÖÂØ¶‰Ωú):
3. ML Ë®ìÁ∑¥Êï∏ÊìöÁîüÊàê  ‚Üê Not implemented
4. RL Ê±∫Á≠ñÁÆóÊ≥ï        ‚Üê Not implemented
```

**Conclusion**: RL training is **independent** from orbit-engine (separate project)

---

## üìã Dependencies Summary

| Dependency | Source | Usage Method | Verification |
|------------|--------|--------------|--------------|
| **Starlink Satellite Pool** | orbit-engine Stage 4 | Read JSON (satellite IDs) | 101 Starlink satellites |
| **Signal Algorithms** | orbit-engine Stage 5 | Call algorithms (real-time) | ITU-R + 3GPP calculators |
| **3GPP Events (Optional)** | orbit-engine Stage 6 | Read JSON (baseline comparison) | A3/A4/A5/D2 events |
| **TLE Data** | orbit-engine Stage 1 | Via OrbitEngineAdapter | 79 TLE files, 84 days coverage |
| **Ground Station Config** | `config/data_gen_config.yaml` | Via OrbitEngineAdapter | NTPU: 24.9441¬∞N, 121.3714¬∞E |

---

## üö® Common Mistakes (Lessons Learned)

### Mistake 1: Confusing "Stage 5" in README.md
- **README.md said**: "from orbit-engine Stage 5" (‚ùå incorrect)
- **Actually from**: Stage 4 Pool Optimization (‚úÖ correct)
- **Fixed**: 2025-10-19 - README.md corrected to Stage 4

### Mistake 2: Assuming "First 101 from TLE"
- **Wrong assumption**: Take first 101 Starlink satellites alphabetically from TLE
- **Correct**: 101 = result of six-stage optimization (visibility, service windows, etc.)
- **Fix**: Always read from Stage 4 output

### Mistake 3: Including OneWeb Satellites
- **Wrong assumption**: Need multi-constellation diversity
- **Correct**: Project uses Starlink-only (cross-constellation handover unrealistic)
- **Fix**: Extract only Starlink from Stage 4 pool

---

**Date**: 2025-10-19
**Status**: ‚úÖ DOCUMENTED - Use this as reference for all satellite loading

---

## üîß Critical Implementation Fixes (2025-10-19)

### Issue 1: TLE Loading for Starlink Satellites
**Problem**: Need TLE data for 101 Starlink satellites from Stage 4
- Starlink TLEs: `../orbit-engine/data/tle_data/starlink/tle`
- OneWeb TLEs: Not needed (project uses Starlink-only)

**Fix**: TLELoader configured for Starlink constellation
```python
# src/adapters/tle_loader.py - Starlink TLE source
TLELoader(tle_sources=[
    ('/path/to/starlink/tle', 'starlink_*.tle')
])
```

**Result**:
- ‚úÖ 79 Starlink TLE files loaded
- ‚úÖ All 101 Stage 4 Starlink satellites found
- ‚úÖ Project scope: Starlink-only (cross-constellation handover unrealistic)

### Issue 2: Training Time Window Mismatch
**Problem**: Training time didn't match Stage 4 service windows
- Stage 4 satellites visible: 2025-10-16 03:00:30 - 03:10:30
- Training start time: 2025-10-07 12:00:00 (9 days before!)
- Result: 0 visible satellites, all episodes reward=-1.00

**Root Cause**: LEO satellites only visible ~10 minutes per pass. Stage 4 analyzed specific service windows, but training used arbitrary time.

**Fix**: Use Stage 4 time range for training
```python
# train_online_rl.py
start_time = datetime(2025, 10, 16, 3, 0, 30)  # Match Stage 4 service window
```

**Result**:
- ‚úÖ Satellites visible (3-10 per episode)
- ‚úÖ Realistic RSRP (-85.6 dBm average)
- ‚úÖ Positive rewards (+0.67 to +0.84)
- ‚úÖ Handover events occurring (2-3 per episode)

**Future Improvement**: For longer training, use multiple service window periods or generate episodes across different satellite passes.

---

## üìä Complete Data Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    orbit-engine (6 Stages)                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  Stage 1: TLE Loading                                           ‚îÇ
‚îÇ    ‚Üì Output: 8,632 satellites with TLE data                     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Stage 2: Orbital Propagation (SGP4)                            ‚îÇ
‚îÇ    ‚Üì Output: TEME coordinates                                   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Stage 3: Coordinate Transformation                             ‚îÇ
‚îÇ    ‚Üì Output: WGS84 coordinates + visibility                     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Stage 4: Pool Optimization ‚≠ê handover-rl READS THIS           ‚îÇ
‚îÇ    ‚Üì Output: 125 satellite IDs (101 Starlink + 24 OneWeb)       ‚îÇ
‚îÇ    ‚Üì JSON: pool_optimization['optimized_pools']                 ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Stage 5: Signal Quality Analysis ‚≠ê handover-rl USES ALGORITHMS‚îÇ
‚îÇ    ‚Üì Algorithms: ITU-R P.676 + 3GPP TS 38.214/38.215           ‚îÇ
‚îÇ    ‚Üì JSON: Pre-computed RSRP/RSRQ/SINR (fixed time range)      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Stage 6: 3GPP Events ‚≠ê handover-rl OPTIONAL BASELINE          ‚îÇ
‚îÇ    ‚Üì Output: A3/A4/A5/D2 events for comparison                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              handover-rl (Independent RL Training)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  1. Load 125 Satellite IDs                                      ‚îÇ
‚îÇ     ‚Üê FROM: Stage 4 JSON (pool_optimization)                    ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  2. OrbitEngineAdapter                                          ‚îÇ
‚îÇ     ‚îú‚îÄ Uses Stage 5 algorithms (real-time calculation)          ‚îÇ
‚îÇ     ‚îú‚îÄ Calls: ITU-R P.676, 3GPP TS 38.214/38.215               ‚îÇ
‚îÇ     ‚îî‚îÄ Computes: RSRP/RSRQ/SINR for any time point             ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  3. Environment State (12 dimensions)                           ‚îÇ
‚îÇ     ‚îú‚îÄ Signal Quality (5): RSRP, RSRQ, SINR, offsets           ‚îÇ
‚îÇ     ‚îî‚îÄ Physical Params (7): distance, elevation, doppler, ...   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  4. DQN Agent                                                   ‚îÇ
‚îÇ     ‚îú‚îÄ Learns: Handover policy from experience                  ‚îÇ
‚îÇ     ‚îî‚îÄ Does NOT use: Stage 6 A3 events (learns own strategy)    ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  5. (Optional) Baseline Comparison                              ‚îÇ
‚îÇ     ‚îî‚îÄ Compare with: Stage 6 A3 event-based handover            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Key Relationships**:
- **Stage 4 ‚Üí handover-rl**: Provides satellite pool (read JSON)
- **Stage 5 ‚Üí handover-rl**: Provides algorithms (call functions, not read JSON)
- **Stage 6 ‚Üí handover-rl**: Optional baseline (A3 events for comparison)

**Why This Architecture**:
- orbit-engine = Offline data processing (fixed time range)
- handover-rl = Online RL training (arbitrary time points)
- Need real-time calculation ‚Üí Use algorithms, not pre-computed data

---

**Last Updated**: 2025-10-19
**Status**: ‚úÖ Complete data dependency documentation
